# ---- Web build stage (monorepo) ----
FROM node:22-alpine AS web-build
WORKDIR /workspace

COPY package.json package-lock.json ./
COPY packages/ ./packages/
COPY web/ ./web/
COPY turbo.json tsconfig.json ./

# install all workspace deps using the single root lockfile
RUN npm ci --include=dev

# build the web workspace; pass API URL at build-time
ARG VITE_API_BASE_URL
ENV VITE_API_BASE_URL=${VITE_API_BASE_URL}
RUN npm run build:frontend

# ---- Runtime: Caddy serving the built web + reverse proxy for APIs ----
FROM caddy:2

# Caddyfile config (see below)
COPY Caddyfile /etc/caddy/Caddyfile

# Caddy serves from /usr/share/caddy by default
COPY --from=web-build /workspace/web/dist /usr/share/caddy
